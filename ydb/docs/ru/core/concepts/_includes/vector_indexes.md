# Векторные индексы

{{ ydb-short-name }} поддерживает специализированные _векторные индексы_ для эффективного поиска k ближайших строк к вектору запроса. В отличие от вторичных индексов, оптимизирующих поиск по равенству или диапазону, векторные индексы позволяют выполнять поиск по сходству на основе функций расстояния или схожести.

## Характеристики векторных индексов {#characteristics}

Векторные индексы в {{ ydb-short-name }}:

* Решают задачу поиска ближайших соседей с использованием функций схожести или расстояния
* В текущей версии не поддерживают изменение строк в таблицах с векторными индексами (планируется в будущих релизах)
* Поддерживают несколько функций расстояния/схожести: "inner_product", "cosine" (схожесть) и "cosine", "euclidean", "manhattan" (расстояние)
* В текущей реализации доступен один тип индекса: `vector_kmeans_tree`

## Типы векторных индексов {#types}

### Базовый векторный индекс {#basic}

Простейшая форма, индексирующая векторы без дополнительных возможностей фильтрации. Пример создания:

```yql
ALTER TABLE my_table
  ADD INDEX my_index
  GLOBAL USING vector_kmeans_tree
  ON (embedding)
  WITH (distance=cosine, vector_type="uint8", vector_dimension=512, levels=2, clusters=128);
```

### Векторный индекс с покрывающими колонками {#covering}

Включает дополнительные колонки, чтобы избежать чтения из основной таблицы при запросах:

```yql
ALTER TABLE my_table
  ADD INDEX my_index
  GLOBAL USING vector_kmeans_tree
  ON (embedding) COVER (data)
  WITH (distance=cosine, vector_type="uint8", vector_dimension=512, levels=2, clusters=128);
```

### Векторный индекс с префиксом {#prefixed}

Позволяет фильтровать по префиксным колонкам перед выполнением векторного поиска:

```yql
ALTER TABLE my_table
  ADD INDEX my_index
  GLOBAL USING vector_kmeans_tree
  ON (user, embedding)
  WITH (distance=cosine, vector_type="uint8", vector_dimension=512, levels=2, clusters=128);
```

### Векторный индекс с префиксом и покрывающими колонками {#prefixed-covering}

Комбинирует префиксную фильтрацию с покрывающими колонками для оптимальной производительности:

```yql
ALTER TABLE my_table
  ADD INDEX my_index
  GLOBAL USING vector_kmeans_tree
  ON (user, embedding) COVER (data)
  WITH (distance=cosine, vector_type="uint8", vector_dimension=512, levels=2, clusters=128);
```

## Создание векторных индексов {#creation}

Векторные индексы можно создавать:

* При создании таблицы с помощью YQL-оператора CREATE TABLE
* Добавлять к существующей таблице с помощью YQL-оператора ALTER TABLE

Обязательные параметры для vector_kmeans_tree:
* distance или similarity: Используемая функция (например, "cosine")
* vector_type: Тип данных элементов вектора ("float", "int8", "uint8")
* vector_dimension: Размерность векторов (<= 16384)
* levels: Количество уровней дерева
* clusters: Количество кластеров на уровень (значения > 1000 могут ухудшить производительность)

## Использование векторных индексов {#usage}

Запросы к векторным индексам выполняются с использованием синтаксиса VIEW в YQL. Для индексов с префиксом укажите префиксные колонки в условии WHERE:

```yql
SELECT user, data
FROM my_table VIEW my_index
WHERE user = "..."
ORDER BY Knn::CosineSimilarity(embedding, ...) DESC
LIMIT 10;
```

## Типичные сценарии использования {#usecases}

Векторные индексы особенно полезны для:

* Рекомендательных систем (поиск похожих товаров/пользователей)
* Семантического поиска (сопоставление текстовых эмбеддингов)
* Поиска похожих изображений
* Обнаружения аномалий (поиск выбросов)
* Классификационных систем (поиск ближайших размеченных примеров)

## Ограничения {#limitations}

Текущие ограничения векторных индексов:

* Не поддерживается изменение строк в индексированных таблицах
* Тип битовых векторов в настоящее время не поддерживается